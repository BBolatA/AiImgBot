{% extends "base.html" %}
{% load static %}

{% block title %}–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é{% endblock %}

{% block main_content %}
<div class="container">
  <section class="grid grid--cols-auto">
    <a class="card" href="{% url 'gallery' %}">
      <span style="font-size:48px">üñº</span>
      <span class="card__title">–ì–∞–ª–µ—Ä–µ—è</span>
    </a>
    <a class="card" href="{% url 'analytics' %}">
      <span style="font-size:48px">üìä</span>
      <span class="card__title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
    </a>
    <a class="card" href="tg://resolve?domain={{ TELEGRAM_BOT_USERNAME }}" target="_blank">
      <span style="font-size:48px">ü§ñ</span>
      <span class="card__title">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</span>
    </a>
  </section>

  <section class="grid" style="margin-top:var(--space-7)">
    <div class="card card--sm">
      <div class="card__num">{{ total_images|default:"0" }}</div>
      <div class="card__title">–≤—Å–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</div>
    </div>
    <div class="card card--sm">
      <div class="card__num">
        {% if avg_per_day %}{{ avg_per_day|floatformat:1 }}{% else %}0{% endif %}
      </div>
      <div class="card__title">—Å—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å</div>
    </div>
  </section>

  {% if last_images %}
  <section style="margin-top:var(--space-7)">
    <h3 class="card__title" style="margin-bottom:var(--space-3)">
      –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    </h3>
    <div class="grid grid--cols-tight">
      {% for img in last_images %}
        <img class="thumb"
             data-src="{{ img.image.url }}"
             alt="{{ img.task.prompt|truncatechars:40 }}"
             loading="lazy"
             onclick="location.href='{% url 'gallery' %}'">
      {% endfor %}
    </div>
  </section>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
const io = new IntersectionObserver((entries, obs) =>
  entries.forEach(e => {
    if (e.isIntersecting) {
      const img = e.target;
      img.src = img.dataset.src;
      obs.unobserve(img);
    }
  }),
  { rootMargin: '200px' }
);
document.querySelectorAll('[data-src]').forEach(img => io.observe(img));
</script>
{% endblock %}
